apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: prod

resources:
  - ../../base

commonLabels:
  environment: prod

patches:
  # 3 backend replicas in prod for high availability
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 3
    target:
      kind: Deployment
      name: backend

  # 2 frontend replicas in prod
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 2
    target:
      kind: Deployment
      name: frontend

  # Larger PVC in prod
  - patch: |-
      - op: replace
        path: /spec/resources/requests/storage
        value: 5Gi
    target:
      kind: PersistentVolumeClaim
      name: db-pvc

  # Prod uses nodePort 30002
  - patch: |-
      - op: replace
        path: /spec/ports/0/nodePort
        value: 30002
    target:
      kind: Service
      name: frontend-service

  # Full resource limits in prod
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: "200m"
            memory: "256Mi"
          limits:
            cpu: "1000m"
            memory: "1Gi"
    target:
      kind: Deployment
      name: backend

  # DB gets more resources in prod too
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: "250m"
            memory: "256Mi"
          limits:
            cpu: "1000m"
            memory: "1Gi"
    target:
      kind: Deployment
      name: db
